{% extends 'base.html' %}

{% block title %}Receiver{% end %}

{% block style %}
<style>
body
{
  padding: 2em;
}
#history, #pressed
{
  margin-top: -1em;
  padding: 0 !important;
  min-height: 32px;
}
#history .label
{
  padding: 0.2em 0.3em 0.3em 0.3em;
  margin: 0.2em;
}
</style>
{% end %}

{% block content %}
{% include header.html %}
<h4 class="ui header">Current</h4>
<div class="ui labels" id="pressed"></div>
<h4 class="ui header">History</h4>
<div class="ui labels" id="history"></div>
{% end %}


{% block scripts %}
<script>
init_header('receiver');

var pressed = {};
var last_time = 0;
var ws_url = 'ws://'+location.host+'/ws/r'+location.search;
if (ws_url.indexOf('?') == -1) ws_url = ws_url.replace('&','?');
var client = new WSClient(ws_url,true);
client.connect();
client.onkey = function(key) {
  console.log(key);
  var char = key.key;
  var code = key.keycode;
  if (!char) return;
  if (char == ' ') char = 'Space';

  if (key.keyaction == 'keydown')
  {
    if (pressed[code] ==  undefined)
    {
      pressed[code] = key;
      var new_label = $('<div class="ui teal label" code="'+code+'">' + char + '</div>')
      $('#pressed').append(new_label);
    }
  }
  else {
    delete pressed[code];
    $('#pressed [code="'+code+'"]').remove();

    if (code == 16 || code == 17 || code == 18) return; //Ctrl Shift Alt
    if (key.is_alt_down) char = 'Alt + ' + char;
    if (key.is_shift_down) char = 'Shift + ' + char;
    if (key.is_alt_down) char = 'Ctrl + ' + char;
    var new_label = $('<div class="ui basic small label">' + char + '</div>')
    var current_time = Math.floor(Date.now() / 1000);
    if (current_time - last_time > 60)
      new_label.css('margin-left',60);
    else
      new_label.css('margin-left',current_time - last_time - 4);
    last_time = current_time;
    $('#history').append(new_label);
    new_label.transition('fade in');
    setTimeout(function(){fadeout(new_label);}, 3*60000);
  }
}
client.onstatechange = function(state) {
  if (state == "Online") $('#state').addClass('teal').text(state);
  else $('#state').removeClass('teal').text(state);
}
function fadeout(target, time)
{
  target.transition('fade out',{
    duration   : time || '2s',
    onComplete : function() {
      target.remove();
    }})
}
</script>

{% end %}
