{% extends 'base.html' %}

{% block title %}Sender{% end %}

{% block style %}
<style>
body
{
  padding: 2em;
}
#pressed
{
  padding: 1em 0 !important;
  height: 70px;
}
.options .checkbox
{
  display: block;
  margin: 0.5em 0;
  font-size: 0.7em;
}
</style>
{% end %}

{% block content %}
<div class="ui grid" style="max-width:500px">
  <div class="ui row">
    <div class="eight wide column">
      <h3 class="ui header"><i class="icon keyboard"></i> Sender <div id="state" class="ui sub header">Offline</div></h3>
      <div class="ui labels" id="pressed"></div>
    </div>
    <div class="eight wide column">
      <div class="options">
        <h5 class="ui header">Options</h5>
        <div class="ui slider checkbox checked">
          <input type="checkbox" checked="checked">
          <label>Key Catch</label>
        </div>
        <h5 class="ui header">Keyboards</h5>
        <div class="ui slider checkbox checked">
          <input type="checkbox" checked="checked">
          <label>QWERT Keyboard</label>
        </div>
        <div class="ui slider checkbox">
          <input type="checkbox">
          <label>Function Keyboard</label>
        </div>
        <div class="ui slider checkbox">
          <input type="checkbox">
          <label>Numpad</label>
        </div>
        <div class="ui slider checkbox">
          <input type="checkbox">
          <label>Touchpad</label>
        </div>
      </div>
    </div>
  </div>
  <div class="ui row">
    <div class="keyboard qwert"></div>
  </div>
  <div class="ui row">
    <div class="eight wide column" style="padding:0">
      <div class="keyboard functional"></div>
    </div>
    <div class="eight wide column" style="padding:0">
      <div class="keyboard numpad"></div>
    </div>
  </div>
</div>

<input id="input" style="backgound:none;border:none;display:none;">
{% end %}


{% block scripts %}
<script>
var is_shift_down = false;
var is_ctrl_down = false;
var is_alt_down = false;
function init_keyboards() {
  $('.keyboard key').each(function(i,e) {
    e = $(e);
    e.mousedown(function(){
      var event = {};
      event.type = "keydown";
      event.key = e.text();
      event.keyCode = e.attr('code');
      event.shiftKey = is_shift_down;
      event.ctrlKey = is_ctrl_down;
      event.altKey = is_alt_down;
      e.down = true;
      sendkey(event);
    });
    e.mouseup(function(){
      var event = {};
      event.type = "keyup";
      event.key = e.text();
      event.keyCode = e.attr('code');
      event.shiftKey = is_shift_down;
      event.ctrlKey = is_ctrl_down;
      event.altKey = is_alt_down;
      e.down = false;
      sendkey(event);
    });
    e.mouseleave(function(){
      if (e.down)
      {
        var event = {};
        event.type = "keyup";
        event.key = e.text();
        event.keyCode = e.attr('code');
        event.shiftKey = is_shift_down;
        event.ctrlKey = is_ctrl_down;
        event.altKey = is_alt_down;
        sendkey(event);
        e.down =false;
      }
    });
  })
}
var numpad = {
  keys:["123","456","789","0"],
  row:4,
  span:[0,0,0,2],
  target:'.keyboard.numpad'
}
var qwert_full = {
  keys:[
    "1234567890-=",
    "QWERTYUIOP[]",
    "ASDFGHJKL;''",
    [
      {code:16,key:'Shift',display:'<i class="icon arrow up"></i>',width:1.5},
      "ZXCVBNM,./",
      {code:8,key:'Backspace',display:'<i class="icon arrow circle left"></i>',width:1.5}
    ]
  ],
  span:[0,1,2,0],
  row:4,
  target:'.keyboard.qwert'
}
var qwert = {
  keys:[
    "QWERTYUIOP",
    "ASDFGHJKL",
    "ZXCVBNM"
  ],
  span:[0,1,2],
  row:3,
  target:'.keyboard.qwert'
}
var func = {
  keys:[[
    {code:38,key:"↑"}
  ],[
    {code:37,key:"←"},
    {code:40,key:"↓"},
    {code:39,key:"→"}
  ],[
  ]],
  span:[2,0,0],
  row:3,
  target:'.keyboard.functional'
}

function make_keyboard(keymap) {
  var target = $(keymap.target).empty();
  for (var r=0; r<keymap.row; r++)
  {
    if (keymap.span)
      for (var s=0; s<keymap.span[r]; s++)
        target.append('<span></span>')
    var keys = keymap.keys[r];
    if (typeof keys == "string")
      keys = [keys];
    for (var c=0; c<keys.length; c++)
    {
      var obj = keys[c];
      if (typeof obj == "string")
        for (var k=0; k<obj.length; k++)
          target.append('<key code="'+obj.charCodeAt(k)+'" key="'+obj[k]+'">'+obj[k]+'</key>');
      else
        target.append('<key code="'+obj.code+'" key="'+obj.key+'" style="width:'+(32*(obj.width||1))+'px">'+(obj.display||obj.key)+'</key>')
    }
    target.append('<br>')
  }
}
make_keyboard(qwert);
make_keyboard(numpad);
make_keyboard(func);
init_keyboards();


var pressed = {};
var client = new WSClient('ws://'+location.host+'/ws/s','hello',true,true);
client.connect();
client.onkey = function(key) {
  alert(key);
}
client.onstatechange = function(state) {
  if (state) $('#state').addClass('teal').text('Online');
  else $('#state').removeClass('teal').text('Offline');
}
function sendkey(event) {
  var keycode = event.keyCode;
  var obj = {};
  obj.action = 'key';
  obj.subaction = event.type;
  obj.data = {};
  obj.data.keyaction = event.type;
  obj.data.key = event.key;
  obj.data.keycode = event.keyCode;
  obj.data.is_shift_down = event.shiftKey;
  obj.data.is_ctrl_down = event.ctrlKey;
  obj.data.is_alt_down = event.altKey;

  if (event.type == 'keydown')
    if (pressed[keycode] == undefined)
    {
        pressed[keycode] = obj;
        var new_label = $('<div class="ui teal label" code="'+keycode+'">' + event.key + '</div>')
        $('#pressed').append(new_label);
    }
    else
      return;
  else
  {
    delete pressed[keycode];
    $('#pressed [code="'+keycode+'"]').remove();
  }
  console.log(event,obj);
  client.sendkey(obj);
}
document.addEventListener('keydown', function(event) {
    sendkey(event);
    event.preventDefault();
    return false;
});
document.addEventListener('keyup', function(event) {
    sendkey(event);
    event.preventDefault();
    return false;
});
</script>
{% end %}
