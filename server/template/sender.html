{% extends 'base.html' %}

{% block title %}Sender{% end %}

{% block meta %}
<link rel="stylesheet" href="/static/keyboard.css">
<script src="/static/keyboard.js"></script>
<link rel="stylesheet" href="/static/touchpad.css">
<script src="/static/touchpad.js"></script>
{% end %}


{% block style %}
<style>
body
{
  padding: 2em;
}
#pressed
{
  padding: 1em 0 !important;
  height: 70px;
}
.options .checkbox
{
  display: block;
  margin: 0.5em 0;
  font-size: 0.7em;
}
.breadcrumb .section
{
  color: rgba(0,0,0,0.5);
}
.breadcrumb .section.active
{
  color: rgba(0,0,0,1);
}
</style>
{% end %}

{% block content %}
{% include header.html %}

<div class="ui labels" id="pressed"></div>
<div class="options" style="display:none">
  <h5 class="ui header">Options</h5>
  <div class="ui slider checkbox checked">
    <input type="checkbox" checked="checked">
    <label>Key Catch</label>
  </div>
  <h5 class="ui header">Keyboards</h5>
  <div class="ui slider checkbox checked">
    <input type="checkbox" checked="checked">
    <label>QWERT Keyboard</label>
  </div>
  <div class="ui slider checkbox">
    <input type="checkbox">
    <label>Function Keyboard</label>
  </div>
  <div class="ui slider checkbox">
    <input type="checkbox">
    <label>Numpad</label>
  </div>
  <div class="ui slider checkbox">
    <input type="checkbox">
    <label>Touchpad</label>
  </div>
</div>

<canvas class="touchpad"></canvas>

<div class="dock" style="position:absolute;left:0;right:0;bottom:0;">
  <div style="padding:1em 1em;text-align:center;background:rgba(0,0,0,0.04)">
    <div class="ui breadcrumb">
      <div class="section" onclick="switch_keyboards('qwert',this)">Qwert</div>
      <div class="divider"> | </div>
      <div class="section" onclick="switch_keyboards('symbol',this)">Symbol</div>
      <div class="divider"> | </div>
      <div class="section" onclick="switch_keyboards('qwert-full',this)">Full</div>
      <div class="divider"> | </div>
      <div class="section" onclick="switch_keyboards('numpad',this)">Numpad</div>
      <div class="divider"> | </div>
      <div class="section" onclick="switch_keyboards('functional',this)">Function</div>
      <div class="divider"> | </div>
      <div class="active section" id="none_keyboad" onclick="switch_keyboards(null,this)">None</div>
    </div>
  </div>
  <div class="keyboards">
    <div class="keyboard qwert"></div>
    <div class="keyboard symbol"></div>
    <div class="keyboard qwert-full"></div>
    <div class="keyboard functional"></div>
    <div class="keyboard numpad"></div>
  </div>
</div>
{% end %}

{% block scripts %}
<script>
// Disable scroll
document.body.addEventListener('touchmove', function(event) {
  event.preventDefault();
}, false);

function switch_keyboards(key,bread) {
  $('.keyboard').hide();
  $('.breadcrumb .section').removeClass('active');
  $(bread).addClass('active');
  if(key)
      $('.keyboard.'+key).show();
}
switch_keyboards(null,$('#none_keyboad'));

init_header('sender');

$(function(){
  var keyboard = new Keyboard(sendkey,40);
  keyboard.make(keyboard.qwert);
  keyboard.make(keyboard.qwert_full);
  keyboard.make(keyboard.numpad);
  keyboard.make(keyboard.func);
  keyboard.make(keyboard.symbol);
  keyboard.register_key_event($('.keyboard key'));
  //var touchpad = new Touchpad($('.touchpad'),40);
});



var pressed = {};
var ws_url = 'ws://'+location.host+'/ws/s'+location.search;
if (ws_url.indexOf('?') == -1) ws_url = ws_url.replace('&','?');
var client = new WSClient(ws_url,true);
client.connect();
client.onkey = function(key) {
  alert(key);
}
client.onstatechange = function(state) {
  if (state == "Online") $('#state').addClass('teal').text(state);
  else $('#state').removeClass('teal').text(state);
}
function sendkey(event) {
  var keycode = event.keyCode;
  var obj = {};
  obj.action = 'key';
  obj.subaction = event.type;
  obj.data = {};
  obj.data.keyaction = event.type;
  obj.data.key = event.key;
  obj.data.keycode = event.keyCode;
  obj.data.is_shift_down = event.shiftKey;
  obj.data.is_ctrl_down = event.ctrlKey;
  obj.data.is_alt_down = event.altKey;

  if (event.type == 'keydown')
    if (pressed[keycode] == undefined)
    {
        pressed[keycode] = obj;
        var new_label = $('<div class="ui teal label" code="'+keycode+'">' + event.key + '</div>')
        $('#pressed').append(new_label);
    }
    else
      return;
  else
  {
    delete pressed[keycode];
    $('#pressed [code="'+keycode+'"]').remove();
  }
  console.log(event,obj);
  client.sendkey(obj);
}
document.addEventListener('keydown', function(event) {
    sendkey(event);
    event.preventDefault();
    return false;
});
document.addEventListener('keyup', function(event) {
    sendkey(event);
    event.preventDefault();
    return false;
});
</script>
{% end %}
